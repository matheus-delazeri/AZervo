<?php
$_AZervo = new \App\AZervo();
$_api = $_AZervo->getModel("api");
?>
<html>
<?php $_AZervo->loadBlock("header") ?>
<body>
<?php $_AZervo->loadBlock("topHeader") ?>
<div class="row" style="height: 100%">
    <table class="table table-striped results-table">
        <thead>
        <tr>
            <th style="width: 10%;" scope="col">DOI</th>
            <th style="width: 20%;" scope="col">Autor</th>
            <th style="width: 40%;" scope="col">TÃ­tulo</th>
            <th style="width: 20%;" scope="col">Categoria</th>
            <?php foreach ($_api->DATASETS_MODELS as $dataset) {
                echo '<th style="width: 10%;" scope="col">' . ucfirst($dataset) . '</th>';
            } ?>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="text/javascript">
    let results = JSON.parse(sessionStorage.getItem("azervo_results"))
    jQuery.each(results, function (key, values) {
        jQuery(".results-table tbody").append(`
            <tr class='result' doi='${key}'>
                <td>${key}</td>
                <td>${values.author}</td>
                <td>${values.title}</td>
                <td>${values.type}</td>
                <?php foreach ($_api->DATASETS_MODELS as $dataset) {
                    echo '<td class="dataset '.$dataset.'"><img class="loading-gif" src="'.$_AZervo->getSkinUrl('images/loading.gif').'"></td>';
                } ?>
            </tr>
        `)
    })
    document.addEventListener("DOMContentLoaded", function () {
        jQuery(".result").each(function () {
            let doi = jQuery(this).attr("doi")
            let $this = this
            jQuery.ajax({
                url: '<?php echo $_AZervo::getUrl("search", "inDatasets")?>',
                method: "POST",
                data: {
                    doi: doi
                },
                dataType: "json",
                error: function() {
                    let datasetEl = jQuery($this).find('.dataset')
                    jQuery(datasetEl).html("Tempo excedido")
                },
                success: function (results) {
                    jQuery.each(results, function (dataset, url) {
                        let datasetEl = jQuery($this).find(`.${dataset}`)
                        jQuery(datasetEl).html(url)

                    })
                },
                timeout: 60000
            })
        })
    })
</script>
</body>
</html>