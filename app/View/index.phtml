<?php
$_AZervo = new \App\AZervo();
$_api = new \App\Model\Api();
?>
<html>
    <?php $_AZervo->loadBlock("header")?>
    <body>
        <?php $_AZervo->loadBlock("topHeader")?>
        <div class="row" style="align-items: center; height: 70%">
            <div class="col-md-4"></div>
            <div class="col-md-4">
                <img width="100%" src="<?php echo $_AZervo->getSkinUrl('images/logo-desc.png')?>">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
                        <div class="dropdown-menu">
                            <?php
                                foreach ($_api->FILTERS as $filter => $label) {
                                    echo "<a class='dropdown-item' filter='$filter' id='filter-$filter' href='#'>$label</a>";
                                }
                            ?>
                        </div>
                    </div>
                    <input type="text" class="form-control search-query" placeholder="Digite aqui..." aria-label="Digite o tÃ­tulo ou autor do documento..." aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary btn-search" type="button">Buscar</button>
                    </div>
                </div>
                <div class="searching" style="display: none">
                    <span>Buscando resultados <img class="loading-gif" src='<?php echo $_AZervo->getSkinUrl("images/loading.gif")?>'></span>
                </div>
            </div>
            <div class="col-md-4"></div>
        </div>
        <script type="text/javascript">
            let searchFilter = "title"
            jQuery(".dropdown-toggle").text(jQuery("#filter-title").text())
            jQuery(".dropdown-item").click(function () {
                jQuery(".dropdown-toggle").text(jQuery(this).text())
                searchFilter = jQuery(this).attr("filter")
            })
            jQuery(".btn-search").click(function() {
                jQuery(".searching").show()
                let searchUrl = "<?php echo $_AZervo->getUrl("search")?>"
                let resultsUrl = "<?php echo $_AZervo->getUrl("search", "results")?>";
                let searchQuery = jQuery(".search-query").val()
                if(searchQuery !== "") {
                    jQuery.ajax({
                        url: searchUrl,
                        method: "POST",
                        data: {
                            query: searchQuery,
                            filter: searchFilter
                        },
                        dataType: "json",
                        success: function (data){
                            sessionStorage.setItem("azervo_results", JSON.stringify(data))
                            jQuery(".searching").hide()
                            window.location.replace(resultsUrl)
                        }
                    })
                } else {
                    alert("Digite algum valor na barra de busca")
                }
            })
        </script>
    </body>
</html>